name: Run Django Tests

on:
    push:
        branches: [ "main", "dev" ]
    pull_request:
        branches: [ "main" ]

jobs:
    test:
        name: Teste com Python ${{ matrix.python-version }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.10", "3.11"]

        steps:
            - name: "Clonando o repositório"
              uses: actions/checkout@v4

            - name: "Configurando o Python ${{ matrix.python-version }}"
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: "Instalando dependências"
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install -r requirements-dev.txt
                  pip install pytest pytest-cov

            - name: "Rodando os testes com pytest e gerando coverage"
              run: |
                  pytest --cov=.  # --cov-report=xml

            - name: "Renomeando arquivo de coverage para evitar conflitos"
              run: mv .coverage .coverage.${{ matrix.python-version }}

            - name: "Enviando artefato de coverage"
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-data-${{ matrix.python-version }}
                  path: .coverage.${{ matrix.python-version }}
                  retention-days: 1

    coverage:
        name: "Calcular e Salvar Coverage"
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: "Clonando o repositório"
              uses: actions/checkout@v4

            - name: "Configurando o Python"
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'

            - name: "Instalando dependências de coverage"
              run: |
                  python -m pip install --upgrade pip
                  pip install coverage

            - name: "Baixando artefatos de coverage"
              uses: actions/download-artifact@v4
              with:
                  pattern: coverage-data-*
                  path: coverage-artifacts
                  # merge-multiple: true

            - name: "Movendo arquivos de coverage para a raiz"
              run: |
                  find coverage-artifacts -name ".coverage.*" -exec mv {} . \;

            - name: "Combinando relatórios de coverage"
              run: |
                  coverage combine
                  coverage report
                  coverage json

            - name: "Gerando o badge de coverage"
              id: coverage_badge
              uses: tj-actions/coverage-badge-py@v2
              with:
                  green: 85
                  yellow: 60
                  output: coverage.svg

            - name: "Verificando o status do repositório"
              run: git status

            - name: "Commitando o novo badge de coverage"
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "chore: Atualiza badge de coverage"
                  file_pattern: coverage.svg
                  commit_user_name: GitHub Actions
                  commit_user_email: actions@github.com
                  commit_author: GitHub Actions <actions@github.com>
